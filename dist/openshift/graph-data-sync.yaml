---
apiVersion: v1
kind: Template
metadata:
  name: cincinnati
objects:
  - apiVersion: apps/v1
    kind: Deployment
    metadata:
      labels:
        app: cincinnati-graph-data-sync
      name: cincinnati-graph-data-sync
    spec:
      replicas: 1
      selector:
        matchLabels:
          app: cincinnati-graph-data-sync
      strategy:
        type: Recreate
      template:
        metadata:
          labels:
            app: cincinnati-graph-data-sync
          name: cincinnati-graph-data-sync
        spec:
          containers:
            - args:
                - -c
                - |
                  set -euo pipefail

                  pip install --user PyYAML

                  cd /tmp
                  while sleep 600
                  do
                    rm -rf blocked-edges channels
                    curl -L https://github.com/openshift/cincinnati-graph-data/archive/master.tar.gz |
                      tar -xzv --strip-components=1
                    hack/graph-util.py push-to-quay --token-file /etc/secrets/registry-credentials
                  done
              command:
                - /bin/bash
              env:
                - name: HOME
                  value: /tmp
              image: docker.io/library/python:3
              imagePullPolicy: Always
              name: cincinnati-graph-data-sync
              resources:
                limits:
                  cpu: 300m
                  memory: 128Mi
                requests:
                  cpu: 100m
                  memory: 32Mi
              volumeMounts:
                - mountPath: /etc/secrets
                  name: secrets
                  readOnly: 'true'
          volumes:
            - name: secrets
              secret:
                secretName: cincinnati-graph-data-sync-registry-credentials
